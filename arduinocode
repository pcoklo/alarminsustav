#include <SoftwareSerial.h>

int ledPin = 13;
int wLed = A1;
int yLed = A2;
int gLed = A3;
int rLed = A4;
int doorPin = A5;

String inputString = "";
String nullString = "";
String STRING = "ALARM!";
String key1String = "0300C49D207A"; 
String key2String = "AAAAAAAAAAAA";
String key3String = "BBBBBBBBBBBB";
String key4String = "CCCCCCCCCCCC";
String key5String = "GGGGGGGGGGGG";

boolean flag1 = true;
boolean flag2 = false;
boolean flag3 = true;

boolean key1=false;
boolean key2=false;
boolean key3=false;
boolean key4=false;
boolean key5=false;

void setup() {
  Serial.begin(9600);
  
  pinMode(ledPin, OUTPUT);
  pinMode(wLed, OUTPUT);
  pinMode(yLed, OUTPUT);
  pinMode(gLed, OUTPUT);
  pinMode(rLed, OUTPUT);
  pinMode(doorPin, INPUT_PULLUP);
}//setup

void loop(){
  
  if(Serial.available()>0){
    flag2 = true;
    Serial.read();
    delay(10);
    while(inputString.length()<12){
      inputString +=char(Serial.read());
      delay(10);
    }
    digitalWrite(wLed, HIGH);
    Serial.read();
    
    if(Serial.available()==0) check();
  }//if(Serial.available()>0)
/*  
  while (Serial.available() > 0) {
    inputString +=char(Serial.read());
    delay(10);
    if(Serial.available()==0) check();
  }
  */
  
  digitalWrite(rLed, flag1);
  digitalWrite(gLed,!flag1);
  if (digitalRead(doorPin) == HIGH && flag1 && flag3) sendmsg(); 
  else if (digitalRead(doorPin) == LOW) flag3 = true;
  
  if (flag2 && Serial.available()==0){
    digitalWrite(yLed, HIGH);
    for(int i=0;i<2000;i++){
      Serial.read();
      delay(1);
    }
    digitalWrite(yLed, LOW);
    flag2=false;
  }
}//loop

void check(){
  digitalWrite(wLed, LOW);
  if(inputString == key1String){
//    Serial.println("Autorizacija uspjesna!");
    key1 = !key1;
  }
  else if(inputString == key2String){
//    Serial.println("Autorizacija uspjesna!"); 
    key2 = !key2;
  }
  else if(inputString == key3String){
//    Serial.println("Autorizacija uspjesna!");
    key3 = !key3;
  }
  else if(inputString == key4String){
//    Serial.println("Autorizacija uspjesna!");
    key4 = !key4;
  }
  else if(inputString == key5String){
//    Serial.println("Autorizacija uspjesna!");
    key5 = !key5;
  }
  else{
//    Serial.println("Autorizacija neuspjesna!");
    inputString=nullString;
  }//else
  
  if(key1+key2+key3+key4+key5>0) unlock();
  else {
    flag1=true;
//    Serial.println("Alarm ukljucen!");
    inputString=nullString;
  }
}//check()

void unlock(){
  
  if(flag1){
//    Serial.println("Alarm iskuljucen!");
    flag1=false;
  }
  inputString=nullString;
}

void sendmsg (){
  
  SoftwareSerial mySerial(3,2);
  mySerial.begin(4800);
  
  digitalWrite(ledPin, 1); // Turn LED on.
  mySerial.println("AT"); // Sends AT command to wake up cell phone
  delay(500);
  mySerial.println("AT+CMGF=1"); // Puts phone into SMS mode
  delay(1000); // Wait a second
  mySerial.println("AT+CMGW=\"+385919429140\""); // YOUR NUMBER HERE; Creates new message to number
  delay(1000);
  mySerial.print(STRING); // Message contents
  delay(1000);
  mySerial.write(byte(26)); // (signals end of message)
  delay(1000);
  mySerial.println("AT+CMSS=1"); // Sends message at index of 1
  digitalWrite(ledPin, 0); // Turn LED off
  delay(250);
  digitalWrite(ledPin, 1); // Turn LED on.
  delay(5000); // Give the phone time to send the SMS
  mySerial.println("AT+CMGD=1"); // Deletes message at index of 1
  digitalWrite(ledPin, 0); // Turn LED off.
  delay(250);
  flag3 = false;
  
}
