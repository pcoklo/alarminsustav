#include <SoftwareSerial.h>
 
SoftwareSerial my2Serial(3, 2); // RX, TX pins

int ledPin = 13;
int wLed = A1;
int yLed = A2;
int gLed = A3;
int rLed = A4;
int doorPin = A5;

String inputString = "";
String nullString = "";
String key1String = "0300C49D207A"; 
String key2String = "AAA";
String key3String = "BBB";
String key4String = "CCC";
String key5String = "GGG";

boolean flag1 = true;
//boolean flag2 = false;
boolean flag3 = true;

boolean key1=false;
boolean key2=false;
boolean key3=false;
boolean key4=false;
boolean key5=false;

void setup() {
  Serial.begin(9600);
  my2Serial.begin(4800);
  pinMode(ledPin, OUTPUT);
  pinMode(wLed, OUTPUT);
  pinMode(yLed, OUTPUT);
  pinMode(gLed, OUTPUT);
  pinMode(rLed, OUTPUT);
  pinMode(doorPin, INPUT_PULLUP);
}//setup

void loop(){
  
/*  if(my1Serial.available()>0){
    Serial.println("rfid skonto");
    flag2 = true;
    my1Serial.read();
    delay(10);
    while(inputString.length()<12){
      inputString +=char(my1Serial.read());
      delay(10);
    }
    digitalWrite(wLed, HIGH);
    my1Serial.read();
    
    if(my1Serial.available()==0) check();
  }//if(my1Serial.available()>0)
  
  while (Serial.available() > 0) {
    inputString +=char(Serial.read());
    delay(10);
    if(Serial.available()==0) check();
  }*/
  
  if(Serial.available()==0 && !flag1){
    flag1=true;
    check();
    Serial.println(inputString);
  }
  delay(10);
  
  
  digitalWrite(rLed, flag1);
  digitalWrite(gLed,!flag1);
  if (digitalRead(doorPin) == HIGH && flag1 && flag3) sendmsg(); 
  else if (digitalRead(doorPin) == LOW) flag3 = true;
  
/*  if (flag2 && my1Serial.available()==0){
    digitalWrite(yLed, HIGH);
    for(int i=0;i<2000;i++){
      my1Serial.read();
      delay(1);
    }
    digitalWrite(yLed, LOW);
    flag2=false;
  }*/
}//loop

void serialEvent() {
  if(flag1){
    flag1 = false;
    inputString=nullString;
    Serial.read();
    do{
      inputString +=char(Serial.read());
      delay(10);
    }while(inputString.length()<12);
  }else Serial.read();
}

void check(){
  digitalWrite(wLed, LOW);
  if(inputString == key1String){
    Serial.println("Autorizacija uspjesna!");
    key1 = !key1;
  }
  else if(inputString == key2String){
    Serial.println("Autorizacija uspjesna!"); 
    key2 = !key2;
  }
  else if(inputString == key3String){
    Serial.println("Autorizacija uspjesna!");
    key3 = !key3;
  }
  else if(inputString == key4String){
    Serial.println("Autorizacija uspjesna!");
    key4 = !key4;
  }
  else if(inputString == key5String){
    Serial.println("Autorizacija uspjesna!");
    key5 = !key5;
  }
  else{
    Serial.println("Autorizacija neuspjesna!");
    inputString=nullString;
  }//else
  
  if(key1+key2+key3+key4+key5>0) unlock();
  else {
    flag1=true;
    Serial.println("Alarm ukljucen!");
    inputString=nullString;
  }
}//check()

void unlock(){
  
  if(flag1){
    Serial.println("Alarm iskuljucen!");
    flag1=false;
  }
  inputString=nullString;
}

void sendmsg (){
  
  digitalWrite(ledPin, 1); // Turn LED on.
  my2Serial.println("AT"); // Sends AT command to wake up cell phone
  Serial.println("Probudio telefon!");
  delay(500);
  my2Serial.println("AT+CMGF=1"); // Puts phone into SMS mode
  Serial.println("Stavio ga u sms mod");
  delay(1000); // Wait a second
  my2Serial.println("AT+CMGW=\"+14165551234\""); // YOUR NUMBER HERE; Creates new message to number
  Serial.println("Odabrao broj");
  delay(1000);
  my2Serial.print("Sent from my Arduino."); // Message contents
  Serial.println("Upisao poruku");
  delay(1000);
  my2Serial.write(byte(26)); // (signals end of message)
  Serial.println("Signalirao kraj poruke");
  delay(1000);
  my2Serial.println("AT+CMSS=1"); // Sends message at index of 1
  Serial.println("Saljem poruku");
  digitalWrite(ledPin, 0); // Turn LED off
  delay(250);
  digitalWrite(ledPin, 1); // Turn LED on.
  delay(10000); // Give the phone time to send the SMS
  my2Serial.println("AT+CMGD=1"); // Deletes message at index of 1
  Serial.println("Poruka obrisana");
  Serial.println("Kraj");
  digitalWrite(ledPin, 0); // Turn LED off.
  delay(250);
  flag3 = false;
  
}
